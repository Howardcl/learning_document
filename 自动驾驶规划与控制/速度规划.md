# 1.速度规划

## 梯形速度规划：

==将障碍物速度纳入规划过程，以避免速度规划结果的波动，==提高速度规划对动态障碍物的适应性。同时通过引入中间速度值，提高确定运动状态切换时刻的准确性，增强速度规划结果的平稳性。然大梯形的速度曲线已经在加速度上得到了一定的改进，但其仍然是直线加减速，那么在速度的转折处还是存在速度的跳变。



自动驾驶车辆的纵向速度规划，是根据期望路径长度、车辆和前方障碍物速度、最大速度限制等约束生成一条期望路径上的速度曲线，作为自动驾驶车辆的可行驶目标速度，其目的是使得自动驾驶车辆在保持前车速度的同时与之保持一定的安全距离，而归根到底，则是对本车与前车的相对速度



## 纵向速度规划方法设计原理及原则

自动驾驶车辆的纵向速度规划：是根据期望路径长度、车辆和前方障碍物速度、最大速度限制等约束生成一条期望路径上的速度曲线，作为自动驾驶车辆的可行驶目标速度，其目的是使得自动驾驶车辆在保持前车速度的同时与之保持一定的安全距离，归根到底，是本车与前车相对速度和相对距离二者之间关系的研究。

之后由该相对速度规划曲线即可得到期望路径上的绝对速度规划曲线。



基于此，可提出自动驾驶车辆的纵向速度规划设计原则：

1) 为保证安全性，即保证足够的制动距离，应在安全距离之外的路径上进行规划，当自动驾驶车辆与前方障碍物的相对距离等于安全距离时，二者速度应相等，即相对速度为零；
2) 为保证行驶效率，应在待规划路径的安全范围内尽可能地高速行驶；
3) 为保证舒适性以及最大速度、横向稳定性等的限制，应对加速度、速度进行相应约束。



## 基于加减速的纵向速度规划算法

常用的加减速速度规划算法（==例如，梯形速度规划算法、S曲线型速度规划算法和正弦型速度规划算法==）在自动驾驶车辆速度规划中也有很多应用。其特点如下：

a) 梯形速度规划算法的优点是算法简单，车辆响应速度快，效率高。缺点是速度的过渡不够平滑，影响乘客舒适度。

b) S 曲线速度规划算法中任何一点的加速度都是连续变化的，避免了柔性冲击，速度的平滑性很好，运动精度高。但是算法较复杂。

c) 正弦型速度规划算法可以实现平滑的运动，同S型速度曲线相比，在计算上相对简单，且易于实现。



### 梯形速度规划算法

梯形速度曲线控制算法是工业控制领域应用最广的加减速控制策略之一[18-19]，它将整个运动过程分为匀加速、极速和匀减速三个阶段。智能车局部路径规划长度为 S，即假设 S 外部的环境是危险的，故需要在 S 内将车速降为 0。在加速行驶段，若加速度过大，则会造成轮胎滑移或影响乘坐舒适度，故将最大允许加速度限制为$a_a$。在减速行驶段，定义$a_d$为期望减速度，以保证乘坐的舒适性。速度规划曲线、加速度曲线和冲击力曲线如下：

![image-20230913143438270](https://raw.githubusercontent.com/Howardcl/MyImage/main/img/202309131434307.png)

梯形速度规划算法的动态输入量为智能车当前行驶速度$V_i$和规划路径长度 $S$，根据不同的初速度和规划路径长度，梯形速度规划算法得到不同的规划结果。根据当前车速$V_i$和期望减速度$a_d$，可以得到加速段、极速段、匀速段所需距离的计算公式为：

![image-20230913144323442](https://raw.githubusercontent.com/Howardcl/MyImage/main/img/202309131443467.png)

![image-20230913143504927](https://raw.githubusercontent.com/Howardcl/MyImage/main/img/202309131436217.png)



### S曲线型速度规划算法

S曲线型速度规划算法是自动驾驶领域另一种常用的加减速算法，它==将整个运动过程划分为7个阶段，即加加速度段、匀加速度段、减加速度段、匀速段、加减速度段、匀减速度段和减减速度段==，不同阶段速度衔接处加速度连续，且加速度的变化率可控，解决了梯形加减速控制策略存在的加速度突变的问题。S型速度曲线控制算法的速度、加速度即及冲击变化曲线如下图。

![image-20230913145636087](https://raw.githubusercontent.com/Howardcl/MyImage/main/img/202309131456122.png)

![image-20230913153633421](https://raw.githubusercontent.com/Howardcl/MyImage/main/img/202309131540188.png)



![image-20230913153647978](https://raw.githubusercontent.com/Howardcl/MyImage/main/img/202309131540165.png)

不难看出，S型速度曲线柔性较好，克服了梯形速度曲线中存在的加速度突变的不利情况，避免了机器人运动时的柔性冲击，但由于其分段较多、结构复杂，导致算法计算量大、实现起来相对复杂。

### 正弦曲线型速度规划算法

正弦加减速控制算法的速度曲线与S型速度曲线形状类似，整个过程同样分为加速、匀速和减速三个阶段，区别在于其加速度按正弦规律变化，如图

![image-20230913153815723](/home/ubuntu22/.config/Typora/typora-user-images/image-20230913153815723.png)

![image-20230913155329094](https://raw.githubusercontent.com/Howardcl/MyImage/main/img/202309131554433.png)



从上所述表达式可以看出，整个运行过程加速度连续，速度和位移连续光滑。

## 基于模型的纵向速度规划算法

### 基于QP 模型的速度规划算法

首先，建立基于智能车的当前位置和行驶轨迹的 ST 图， 描述智能车与障碍物的运动状态关系及自身速度变化情况。再将速度规划实例化为 QP 模型，包括建立目标函数、构建约束条件以及调用函数库求解。详细过程如下：

1. ST图概述

为有效而简洁地描述智能车与障碍物的运动状态关系及自身速度变化情况，本文建立了 ST 图。==ST 图即路径—时间图==， 首先基于智能车的当前位置和行驶轨迹建立 S-T 坐标系，再依次将障碍物相对于智能车的位置信息及智能车自身的位置信息投影至坐标系中。 如图 1 所示，智能车沿轨迹 S 行驶，动态障碍（以障碍车为例）在 t0至 t1期间行驶至轨迹 s0与 s1之间。 由此建立的 S-T 图如图 2 所示，图中曲线为智能车基于规划结果的运动状态。

![image-20230913160233114](https://raw.githubusercontent.com/Howardcl/MyImage/main/img/202309131602369.png)

1. 求解最优速度

函数库 qpOASES 是一个开源的 C++函数库，主要应用于处理二次规划最优解的求解问题，可以利用 qpOASES 库求解满足约束的最优解。



### 基于最优控制模型的速度规划

==最优控制（Optimal Control，OC）是指在给定的约束条件下，寻求一个控制变量，使得给定的系统性能指标达到最优。==从数学上来看，最优控制问题可以表述为：在系统微分方程、等式和不等式约束以及允许控制范围的要求下，对以控制函数和运动状态为变量的目标函数求取极值。在无人驾驶车辆的纵向速度规划时，需要考虑车辆的牵引/制动性能、线路限速和乘坐舒适度等约束，对于按照时刻表运行的智轨电车还要满足一定的行驶时间要求，而最优控制算法可以处理含有状态终值约束、不等式路径约束的问题，是一种有效可行的速度规划方法。

一般的最优控制模型可以描述为：

![image-20230913162305219](https://raw.githubusercontent.com/Howardcl/MyImage/main/img/202309131623263.png)

综上，以牵引能耗最小为目标的列车最优控制问题可以描述为：对于给定的列车状态方程和状态初值、终值条件，寻找满足限速、加速度和冲击率限制、牵引制动特性限制等约束条件并使目标函数取最小值的控制变量和速度曲线。

==最优控制问题的求解一般分为解析法和数值法。==解析法通过Pontryagin最大值原理，分析最优解的一阶必要条件，通过求解一阶必要条件间接获得最优解；数值法将连续的最优控制模型离散化为非线性数学优化问题，然后使用非线性数学优化方法求解离散得到的近似问题，直接对速度曲线进行寻优。由于解析法难以处理含有复杂约束的问题，比如建模时考虑的速度约束、舒适度约束和牵引/制动特性约束等，所以通常使用数值法求解。

==数值法根据离散方式的不同又可以被分为控制向量参数化方法和正交配置法。==控制向量参数化方法只离散控制变量，通过求解状态微分方程组或者离散的状态变量，从而将最优控制问题转化为非线性数学优化问题；正交配置法同时离散控制变量和状态变量，并将控制曲线和状态曲线使用正交多项式近似，从而将状态微分方程组也转化为一组约束，并最终获得待求解的数学优化问题。最终转化得到的非线性数学优化问题可以使用序列二次规划（Sequential Quadratic Programming，SQP）方法或者内点（Interior Point，IP）方法求解。



### 模型预测控制(MPC)

预测控制（Model Predictive Control, MPC），又称为滚动时域控制，是在 20世纪 70 年代后期提出的一种计算机控制算法。它基于模型对系统未来进行多步预测，通过不断地滚动优化，并采用前馈-反馈的控制结构，它能处理多变量和多系统约束[24]，因此具有良好的控制效果，这使得模型预测控制成为一种适用范围非常广泛的方法。由于模型预测控制具有多模型约束处理优势，能够在无人驾驶车辆控制过程中，处理车辆运动学与动力学等多种约束，是一种理想的速度规划算法[25]。

模型预测的基本原理可以总结为：利用一个已有的模型、系统当前的状态和未来的控制量去预测系统未来的输出，输出的长度是控制周期的整倍数，由于未来的控制量是未知的，所以还需要根据一定的优化条件进行优化求解，从而得到未来的控制量序列，在每一个控制周期结束后，系统根据当前实际状态重新开始预测系统未来输出[26]。模型预测控制在实现过程中有 3 个关键步骤，一般被称为 3 项基本原理，分别是预测模型、滚动优化和反馈校正[27]。模型预测控制的原理框图如下图所示，它包含了模型预测控制器、被控对象和状态观测器[28]。其中，模型预测控制器结合预测模型、目标函数和约束条件进行优化求解，得到系统当前时刻的最优控制序列，并把最优控制序列的第一个量作用于被控对象，状态观测器通过观测或者估计可得到被控对象的状态，然后将系统最新状态量输入到控制器，再次进行优化求解。如此循环，就构成了模型预测控制完整的过程。

![image-20230914100019474](https://raw.githubusercontent.com/Howardcl/MyImage/main/img/202309141000504.png)

用模型预测控制的方法可以设计一个兼顾多目标和多约束的车辆上层速度规划算法，并把上层规划的求解过程转化为一个滚动在线优化的命题，==下面给出MPC 速度规划算法的具体实现步骤：==

a) 初始化需要控制的车辆状态量个数、预测步长、控制步长、最小期望安全间距；

b) 造预测状态空间表达式的系数矩阵并对其初始化；

c) 由获取的前车速度、加速度和两车之间的实际距离信息，实时更新后车的当前状态；

d) 对后车的车辆状态和控制量进行约束并转化为约束矩阵形式；

e) 把需要求解的式转化为带约束的二次规划问题；

f) 利用积极集法或内点法开始求解，计算得到期望的车辆输入序列并保存；

g) 若此次计算无解时，把上个时刻计算得到的控制量的第二个值 u(k+1)作用于当前系统，若此次计算有解时，则把计算出来加速度序列的第一个值 u(k)作用于当前车辆；

h) 返回第三步，在新的时刻重复此计算过程；





# 2.总结

基于加减速的纵向速度规划算法，最明显的优点是算法易于实现能够快速上车实现功能，行业内不少主流方案都采用此种方法实现纵向速度规划。

基于模型的纵向速度规划算法，最明显的优点是能规划中加入若干约束，使系统内的各类指标达到最佳。在无人驾驶车辆速度规划时，需要考虑的因素有很多，如：车辆的牵引/制动性能、线路限速、乘客乘坐的舒适度和能耗等约束。对于需要上线的智轨电车需要按照时刻表运行，还需要满足一定的行驶时间。针对上述要求我们最终选择基于最优控制模型的速度规划算法，这样可以针对上述因素设计相关约束，最终设计有效可行速度规划算法。